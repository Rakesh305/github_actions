name: Helium UI Test

# Trigger on pushes to main (or any branch you choose) and on PRs
on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  ui-test:
    runs-on: ubuntu-latest
    defaults:
      run:
        # Ensure we are always in the repo root
        working-directory: ./

    steps:
    # 1️⃣ Checkout source code
    - name: Checkout repository
      uses: actions/checkout@v4

    # 2️⃣ Set up Python (change to 3.11+ if you need)
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: 3.11

    # 3️⃣ Cache pip packages (speeds up subsequent runs)
    - name: Cache pip
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    # 4️⃣ Install required libraries
    #    - Jupyter (for nbconvert)
    #    - Helium + Selenium
    #    - ChromeDriver (via chromedriver‑autoinstaller)
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install jupyter nbconvert selenium==4.19.0 \
                     helium==0.5.2 chromedriver-autoinstaller==0.6.4
        # Verify ChromeDriver is on PATH (chromedriver‑autoinstaller will download it)
        python -c "import chromedriver_autoinstaller; chromedriver_autoinstaller.install()"

    # 5️⃣ Execute the notebook
    #    nbconvert will write the executed notebook to /tmp/exec-ui-tests.ipynb
    - name: Execute notebook
      run: |
        jupyter nbconvert \
          --to notebook \
          --execute tests/ui_test_sample.ipynb \
          --output /tmp/exec-ui-tests.ipynb \
          --ExecutePreprocessor.timeout=120

    # 6️⃣ Convert the executed notebook to JUnit XML
    - name: Parse notebook to JUnit XML
      run: |
        python scripts/parse_notebook_to_junit.py \
          /tmp/exec-ui-tests.ipynb \
          /tmp/junit-results.xml

    # 7️⃣ Upload screenshot artifact (optional but handy for debugging)
    - name: Upload screenshot artifact
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: screenshot
        path: /tmp/screenshots/github_home.png

    # 8️⃣ Upload JUnit XML artifact (so the Test Summary tab shows results)
    - name: Upload JUnit XML
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: junit-xml
        path: /tmp/junit-results.xml

    # 9️⃣ Show test result in the Actions UI
    - name: Publish test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: junit
        path: /tmp/junit-results.xml

    # 10️⃣ (Optional) Let GitHub display the test results in the *Tests* tab
    - name: Publish JUnit
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: junit-results
        path: /tmp/junit-results.xml
